<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Her Mirror | Personalized Self-Growth</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
    --color-bg-light: #FFF0F5;
    --color-lavender: #E6E6FA;
    --color-purple: #9370DB;
    --color-dark-purple: #8A2BE2;
    --color-pink-border: #FFC0CB;
}
body {
    background-color: var(--color-bg-light);
    color: #333;
    transition: background-color 0.5s;
    font-family: 'Poppins', sans-serif; 
}
.font-serif { font-family: 'Playfair Display', serif; }
.bg-lavender-200 { background-color: var(--color-lavender); }
.text-purple-600 { color: var(--color-dark-purple); }
.bg-purple-500 { background-color: var(--color-purple); }
.hover\:bg-purple-600:hover { background-color: var(--color-dark-purple); }
.border-pink-300 { border-color: var(--color-pink-border); }
.chat-container { height: auto; }
.tab-active { border-bottom: 3px solid var(--color-dark-purple); font-weight: 700; }
.mood-low { background-color: #fca5a5; }
.mood-mid { background-color: #fde68a; }
.mood-high { background-color: #a7f3d0; }
</style>
</head>
<body class="transition-colors duration-500">

<header class="py-6 px-4 sm:px-6 lg:px-8 bg-white/70 backdrop-blur-sm shadow-md sticky top-0 z-10 border-b border-pink-100">
    <div class="flex items-center justify-between max-w-4xl mx-auto">
        <div class="flex items-center space-x-2">
            <a href="#" id="brand-logo" class="flex items-center space-x-2">
                <img src="Mirrormovt logo.jpg" alt="Her Mirror Logo" class="w-8 h-8 rounded-full shadow">
                <h1 class="text-2xl font-bold tracking-tight text-purple-600 font-serif">Her Mirror</h1>
            </a>
        </div>
        <div id="user-id-display" class="text-sm text-gray-500"></div>
    </div>
    <nav class="max-w-4xl mx-auto mt-4">
        <div class="flex justify-center space-x-8 text-lg font-medium text-gray-500">
            <button data-tab="reflection" class="tab-button pb-2 transition duration-150 hover:text-purple-600">Reflection</button>
            <button data-tab="calendar" class="tab-button pb-2 transition duration-150 hover:text-purple-600">Calendar</button>
            <button data-tab="journal" class="tab-button pb-2 transition duration-150 hover:text-purple-600">Journal</button>
        </div>
    </nav>
</header>

<main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 min-h-[calc(100vh-6rem)] flex flex-col">
    <div class="flex-grow w-full">
        <div id="error-message" class="hidden p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert"></div>
        <div id="app-content-area" class="h-full flex flex-col"></div>
    </div>
</main>

<audio id="affirmation-audio" class="hidden"></audio>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = " https://spdecxirbatqmtvxsedq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwZGVjeGlyYmF0cW10dnhzZWRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NzI1ODcsImV4cCI6MjA3OTI0ODU4N30.vVfaDxDpvtjH8i8XgZFA63WUleu-vv7DiSLppxlY7WY";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const REFLECTION_QUESTIONS = [
    { id: 'feeling', prompt: "Welcome, Winkumsü§≠üíó! How does your heart feel today?", type: 'textarea', placeholder: "Feeling inspired, a little tired..." },
    { id: 'goal', prompt: "What small, sacred goal are you focusing on this week?", type: 'text', placeholder: "E.g., Finish reading a chapter." },
    { id: 'preference', prompt: "Which path refuels you more?", type: 'radio', options: ['Creative', 'Restful'] },
    { id: 'energy', prompt: "Physical energy level (1-5)?", type: 'radio', options: ['1','2','3','4','5'] },
    { id: 'stress', prompt: "Biggest obstacle today?", type: 'text', placeholder: "E.g., Procrastination on a big task." }
];

const state = {
    activeTab: 'reflection', activeView: 'login', step: 0, answers: {}, isLoading: false, profile: null,
    error: null, userId: null, isAuthReady: false, userEmail: null, calendarData: {}, journalData: {}
};

const updateState = (newState) => { Object.assign(state, newState); renderApp(); };
const displayError = (message) => {
    const el = document.getElementById('error-message'); el.textContent = message; el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 5000); updateState({ error: message });
};

// --- AUTH FUNCTIONS ---
const signUp = async (email, password, name, phone) => {
    const { data, error } = await supabase.auth.signUp({ email, password, options:{data:{name, phone}} });
    if(error) displayError(error.message);
    else displayLoginView(`Sign up successful! Confirm your email before login.`);
};

const signIn = async (email, password) => {
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) displayError(error.message);
    else { 
        updateState({ userId: data.user.id, userEmail: email, isAuthReady:true });
        document.getElementById('user-id-display').innerHTML = `Winkums ID: ${data.user.id}`;
        fetchUserData(); 
    }
};

const signOut = async () => {
    await supabase.auth.signOut();
    updateState({ activeView:'login', userId:null, userEmail:null });
};

// Fetch calendar/journal/reflections for logged in user
const fetchUserData = async () => {
    const { data: reflections } = await supabase.from('mood_checkins').select('*').eq('user_id', state.userId);
    updateState({ calendarData: reflections, journalData: reflections, activeView:'home' });
};

// --- RENDER VIEWS ---
const renderApp = () => {
    if(state.activeView==='login') renderLoginView();
    else if(state.activeView==='home') renderHomeView();
    else if(state.activeView==='reflection') renderReflectionForm();
    else if(state.activeView==='profile' && state.profile) renderMirrorProfileCard(state.profile);
    else if(state.activeView==='calendar') renderCalendarView();
    else if(state.activeView==='journal') renderJournalView();
    attachEventListeners();
};

const renderLoginView = (msg='') => {
    document.getElementById('app-content-area').innerHTML=`
    <div class="mt-12 max-w-md mx-auto bg-white/70 p-6 rounded-xl shadow-lg border border-pink-200 text-center">
        <h2 class="text-2xl font-serif font-bold text-purple-600 mb-4">Her Mirror Login/Signup</h2>
        ${msg?`<p class="text-green-600 mb-2">${msg}</p>`:''}
        <form id="auth-form" class="flex flex-col gap-4">
            <input type="text" id="name" placeholder="Full Name" required class="p-3 border border-pink-300 rounded-lg bg-lavender-200"/>
            <input type="text" id="phone" placeholder="Phone" required class="p-3 border border-pink-300 rounded-lg bg-lavender-200"/>
            <input type="email" id="email" placeholder="Email" required class="p-3 border border-pink-300 rounded-lg bg-lavender-200"/>
            <input type="password" id="password" placeholder="Password" required class="p-3 border border-pink-300 rounded-lg bg-lavender-200"/>
            <div class="flex justify-between">
                <button type="submit" data-action="login" class="py-2 px-4 bg-purple-600 text-white rounded hover:bg-purple-700">Login</button>
                <button type="submit" data-action="signup" class="py-2 px-4 bg-purple-500 text-white rounded hover:bg-purple-600">Sign Up</button>
            </div>
        </form>
    </div>
    `;
    document.getElementById('auth-form').onsubmit = async (e)=>{
        e.preventDefault();
        const action = e.submitter.dataset.action;
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        if(action==='signup') await signUp(email,password,name,phone);
        else await signIn(email,password);
    };
};

const renderHomeView = () => {
    document.getElementById('app-content-area').innerHTML = `
    <div class="mt-12 flex flex-col items-center text-center p-8 bg-white/70 backdrop-blur-sm rounded-xl shadow-lg border border-pink-200">
        <h2 class="text-4xl font-serif font-bold text-purple-600 mb-4">Welcome, Winkumsü§≠üíó.</h2>
        <p class="text-xl text-gray-600 mb-8 max-w-2xl">This is your cozy space for self-growth. Let's begin today's sacred check-in.</p>
        <button id="start-reflection-button" class="mt-4 py-3 px-8 bg-purple-600 text-white font-bold rounded-full hover:bg-purple-700 transition shadow-lg shadow-purple-300">Begin Reflection Now</button>
    </div>
    `;
};

const renderQuestionField = (q) => {
    if(q.type==='text'||q.type==='textarea'){
        const html = q.type==='textarea'? `<textarea id="${q.id}" name="${q.id}" rows="3" placeholder="${q.placeholder}" required class="w-full p-3 border border-pink-300 rounded-lg bg-lavender-200"></textarea>`:`<input type="text" id="${q.id}" name="${q.id}" placeholder="${q.placeholder}" required class="w-full p-3 border border-pink-300 rounded-lg bg-lavender-200"/>`;
        return `<div class="mb-6 p-4 bg-white rounded-xl shadow-sm border border-pink-100"><label for="${q.id}" class="block text-lg font-semibold text-purple-600 mb-2">${q.prompt}</label>${html}</div>`;
    } else if(q.type==='radio'){
        return `<div class="mb-6 p-4 bg-white rounded-xl shadow-sm border border-pink-100"><label class="block text-lg font-semibold text-purple-600 mb-2">${q.prompt}</label><div class="flex space-x-4 flex-wrap mt-2">${q.options.map(o=>`<label class="inline-flex items-center"><input type="radio" name="${q.id}" value="${o}" required class="form-radio text-purple-600 h-5 w-5 border-pink-300"><span class="ml-2 text-gray-700">${o}</span></label>`).join('')}</div></div>`;
    }
};

const renderReflectionForm = () => {
    const fields = REFLECTION_QUESTIONS.map(renderQuestionField).join('');
    document.getElementById('app-content-area').innerHTML = `
    <div class="h-full flex flex-col">
        <h2 class="text-2xl font-serif font-bold text-center text-gray-700 mb-6">Sacred Check-In</h2>
        <form id="reflection-form" class="p-6 bg-white/70 backdrop-blur-sm rounded-xl shadow-2xl border border-pink-200">${fields}<div class="flex justify-center mt-8"><button type="submit" class="py-3 px-10 bg-purple-600 text-white font-bold rounded-full hover:bg-purple-700 transition shadow-lg shadow-purple-300">Generate My Mirror Profile ‚ú®</button></div></form>
    </div>
    `;
    document.getElementById('reflection-form').addEventListener('submit', handleSubmitForm);
};

const handleSubmitForm = async (event) => {
    event.preventDefault();
    const formData = new FormData(event.target);
    const answers = {}; let isValid=true;
    REFLECTION_QUESTIONS.forEach(q=>{ const val=formData.get(q.id)?.trim(); if(!val) isValid=false; answers[q.id]=val; });
    if(!isValid){ displayError("Fill out all reflection questions!"); return; }
    try{
        await supabase.from('mood_checkins').upsert([{ user_id: state.userId, ...answers, date_key: new Date().toISOString().substring(0,10) }]);
        const profile = { archetypeName: "The Intuitive Dreamer", moodSummary: "Feeling motivated", dailyAffirmation:"You got this!", selfCareSuggestion:"Take a mindful walk", colorPalette:"#D4AFE4", artStyle:"Soft Pastel Hues" }; // Mocked
        updateState({ profile, activeView:'profile' });
    } catch(e){ displayError("Failed to save reflection."); }
};

const renderMirrorProfileCard=(profile)=>{
    const lowOpacityColor=profile.colorPalette+'44';
    document.body.style.backgroundColor=profile.colorPalette+'1A';
    document.getElementById('app-content-area').innerHTML=`
    <div class="mt-8 flex justify-center w-full">
        <div class="flex flex-col items-center">
            <h2 class="text-3xl font-serif font-extrabold text-gray-800 mb-6 border-b-4 border-pink-400 pb-2">Your Inner Mirror Profile</h2>
            <div class="w-full max-w-lg p-6 sm:p-8 rounded-3xl text-white shadow-2xl transition-all duration-700 transform hover:scale-[1.02]" style="background-color: ${profile.colorPalette}; box-shadow: 0 10px 30px -5px ${profile.colorPalette}99;">
                <div class="flex justify-between items-start mb-6"><div class="font-serif text-5xl font-bold tracking-tight">${profile.archetypeName}</div><div class="text-sm font-light italic opacity-80 mt-1">Style: ${profile.artStyle}</div></div>
                <div class="bg-white/80 backdrop-blur p-5 rounded-2xl mb-6 shadow-inner text-gray-800"><h3 class="text-xl font-semibold mb-2 flex items-center">Mood Snapshot</h3><p class="text-base italic leading-relaxed">"${profile.moodSummary}"</p></div>
                <div class="p-5 rounded-2xl mb-6 border-2 border-white/50" style="background-color: ${lowOpacityColor};"><h3 class="text-lg font-bold mb-2 opacity-90">Daily Affirmation</h3><p class="text-xl font-medium tracking-wide">${profile.dailyAffirmation}</p></div>
                <div class="p-5 rounded-2xl bg-white/80 backdrop-blur text-gray-800 shadow-lg"><h3 class="text-xl font-semibold mb-2">Self-Care Suggestion</h3><p class="text-base">${profile.selfCareSuggestion}</p></div>
            </div>
            <button id="new-reflection-button" class="mt-8 py-3 px-8 bg-purple-600 text-white font-bold rounded-full hover:bg-purple-700 transition shadow-lg shadow-purple-300">Start a New Reflection</button>
        </div>
    </div>
    `;
};

const renderCalendarView = ()=>{
    document.getElementById('app-content-area').innerHTML=`<div class="text-center mt-12">Still working on it winkums..soonüòù</div>`;
};
const renderJournalView = ()=>{
    document.getElementById('app-content-area').innerHTML=`<div class="text-center mt-12">Bientot...oops,soon winkumsüòè</div>`;
};

const attachEventListeners = ()=>{
    document.querySelectorAll('.tab-button').forEach(btn=>{ 
        const t=btn.getAttribute('data-tab'); 
        btn.classList.toggle('tab-active', state.activeTab===t); 
        btn.onclick=()=>updateState({activeTab:t,activeView:t==='reflection'?state.profile?'profile':'reflection':t});
    });
    const startBtn=document.getElementById('start-reflection-button'); if(startBtn) startBtn.onclick=()=>updateState({activeView:'reflection'});
    const newBtn=document.getElementById('new-reflection-button'); if(newBtn) newBtn.onclick=()=>updateState({activeView:'reflection'});
};

// --- INITIALIZE ---
const init = async ()=>{
    const { data: { session } } = await supabase.auth.getSession();
    if(session){ updateState({ userId: session.user.id, userEmail: session.user.email, isAuthReady:true }); fetchUserData(); }
    else updateState({ activeView:'login' });
};
init();

</script>
</body>
</html>
